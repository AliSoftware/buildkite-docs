#!/bin/bash

set -eu

. bin/utils.sh

PULL_REQUEST_NUMBER=$(get_branch_pull_request_number $BUILDKITE_BRANCH)

if [ -z "$PULL_REQUEST_NUMBER" ]; then
  echo "No pull request found for branch $BUILDKITE_BRANCH"
  exit 1
fi

# Create placeholder site whilst we build the real thing.
mkdir build
cat << EOF > build/index.html
<!DOCTYPE html>
  <html>
    <head>
      <meta http-equiv="refresh" content="30">
    </head>
    <body>
      <p>Building preview...</p>
      Follow progress here: <a href="$BUILDKITE_BUILD_URL">$BUILDKITE_BUILD_URL</a>
    </body>
</html>
EOF

echo "--- :netlify: Deploying to Netlify"
netlify deploy --auth $NETLIFY_AUTH_TOKEN --site $NETLIFY_SITE_ID --alias $PULL_REQUEST_NUMBER --dir build --json true | tee netlify-deploy.json

PREVIEW_URL=$(cat netlify-deploy.json | jq -r '.deploy_url')
PREVIEW_MESSAGE="Preview URL: $PREVIEW_URL"

echo "--- :buildkite: Annotating build"
buildkite-agent annotate --style "info" --context "netlify/preview-url" "$PREVIEW_MESSAGE"

if [ -z "$(find_github_comment $PULL_REQUEST_NUMBER "$PREVIEW_MESSAGE")" ]; then
  post_github_comment $PULL_REQUEST_NUMBER "$PREVIEW_MESSAGE"
fi
